---
title: "Clean Salty Soil Data"
author: "Irfan Ainuddin, Jessica Shippen, Olivia Lund"
date: "4/6/2020"
output: html_document
---
```{r}
library(tidyverse)
library(kableExtra)
library(pander)
library(bestglm)
library(glmnet)
library(ROCR)
library(mice)
library(forestplot)
```

```{r}
sd <- readRDS(file = "./data/clean_soil_data.rds")
sd_imp <- readRDS(file = "./data/imputed_data.rds")
#create a working set of imputed data.
imp25 <- complete(sd_imp, action=25)

```

```{r}
```




```{r}
densityplot(imp25)
```


## Modeling Exchangable Sodium (ExchNa_ppm) and multiple imputation
```{r}
# with() use the imputed data set and run the model on every imputation (m=30)
model <- with(sd_imp, lm(ExchNa_ppm ~Date_Sampled +  Year + Irr_season + Field_ID + Soil_pH + Soluble_Salts + NO3_D1_ppm + Bicarb_P_ppm + SO4_ppm + ExchK_ppm + ExchCa_ppm + ExchMg_ppm + Zn_ppm + Mn_ppm + Cu_ppm + Boron_ppm + CEC_me_100g + treatment))

## pool() calculate pooled estimates using rubin's rules. 
mi.estimates <- summary(pool(model))
mi.estimates <- mi.estimates[-1,]

kable(pool(model)$pooled[c(1:4,8:9)], digits=3)
```

```{r}
## run model with regular data set, complete denotes the fact that the lm will drop any missing observations
complete.model <- lm(ExchNa_ppm ~ Date_Sampled + Year + Irr_season + Field_ID + Soil_pH + Soluble_Salts + NO3_D1_ppm + Bicarb_P_ppm + SO4_ppm + ExchK_ppm + ExchCa_ppm + ExchMg_ppm + Zn_ppm + Mn_ppm + Cu_ppm + Boron_ppm + CEC_me_100g + treatment, data = sd)


## extract beta estimates from the complete model.
betas <- c(coef(complete.model)[1:4], NA, coef(complete.model)[5:length(coef(complete.model))])
#remove the intercept estimates
betas <- betas[-1]

## calculate and bind the confidence interval, insert NA value for missing winter factor level, bind rest of the CI's
ci <- rbind(confint(complete.model)[1:4,], NA, confint(complete.model)[5:NROW(confint(complete.model)),])
#remove the intercept estimates
ci <- ci[-1,]

```

```{r}
# FOREST PLOTS: 
## complete case (cc) multiple imputation model (mi)
cc.mean <- betas
mi.mean <- mi.estimates[,2]
## calcualte lower limit of CI
cc.ll   <- ci[,1]
mi.ll   <- mi.mean - 1.96*mi.estimates[,3]
## calcualte upper limit of NI
cc.ul   <- ci[,2]
mi.ul   <- mi.mean + 1.96*mi.estimates[,3]
# create names vector to use in forestplot. 
names   <- as.character(mi.estimates[,1])


#create forest plot to visualize variance between complete model and mice model
forestplot(names, 
           legend = c("Complete Model", "MICE"),
           fn.ci_norm = c(fpDrawNormalCI, fpDrawCircleCI), 
           mean = cbind(cc.mean, mi.mean), 
           lower = cbind(cc.ll, mi.ll),
           upper = cbind(cc.ul, mi.ul), 
           col=fpColors(box=c("blue", "darkred")), 
           xlab="Regression coefficients",
           boxsize = .1
           )
```


Wow the scale of variation here is pretty huge, robin suggested we break this into two  graphs and separate by size.



## Variable Selection


```{r}
## NON IMPUTED DATA SET:
#LASSO for predicting ExchNa 
mod_na <- sd %>% select(Date_Sampled, Year, Field_ID, Irr_season, Depth_1, Soil_pH, Soluble_Salts, OM_pct, NO3_D1_ppm, Bicarb_P_ppm, SO4_ppm, ExchK_ppm, ExchCa_ppm, ExchMg_ppm, ExchNa_ppm, Zn_ppm, Fe_ppm, Mn_ppm, Cu_ppm, Boron_ppm, CEC_me_100g, treatment)

##Required, otherwise x  x and y didnt match up. ExchNa has no missing data
mod_na <- na.omit(mod_na)

y <- mod_na$ExchNa_ppm

x <- model.matrix(data= mod_na, ExchNa_ppm ~ .)[,-1]
set.seed(123)

cv.lasso.na <-cv.glmnet(x,y, alpha=1)
glmnet(x,y,alpha=1, lambda=cv.lasso.na$lambda.min) %>% coef()

```

Using soil data with using only complete cases, LASSO dropped: Date_Sampled, Year, Field 3,5,8, Depths 13-24, 37-48, OM_pct, Bicarb_P_ppm, Fe_ppm, Cu_ppm



```{r}
## IMPUTED DATA SET: USING IMPUTATION SET #25
#LASSO for predicting ExchNa 
imp_na <- imp25 %>% select(Date_Sampled, Year, Field_ID, Irr_season, Depth_1, Soil_pH, Soluble_Salts, OM_pct, NO3_D1_ppm, Bicarb_P_ppm, SO4_ppm, ExchK_ppm, ExchCa_ppm, ExchMg_ppm, ExchNa_ppm, Zn_ppm, Fe_ppm, Mn_ppm, Cu_ppm, Boron_ppm, CEC_me_100g, treatment)

imp_na <- na.omit(imp_na)

y <- imp_na$ExchNa_ppm

x <- model.matrix(data= imp_na, ExchNa_ppm ~ .)[,-1]
set.seed(123)

cv.lasso.na <-cv.glmnet(x,y, alpha=1)
glmnet(x,y,alpha=1, lambda=cv.lasso.na$lambda.min) %>% coef()

```


With the imputed data set LASSO only dropws the Winter factor level of the Irrigation Season.


## Date Distribution
```{r}
hist(sd$Year)
```
Most of the data was collected 2000-2005. 


## Exchangable Sodium (Na) Parts Per Million
```{r Sodium PPM over time}

ggplot(sd, aes(x=sd$Year, y=sd$ExchNa_ppm, col=as.factor(sd$Depth_1))) + 
            geom_point() + theme_bw() + theme(legend.position="top") + 
            geom_smooth(se=FALSE, method="lm") + 
            geom_smooth(aes(x=sd$Year, y=sd$ExchNa_ppm), col="blue", se=FALSE, method='lm') + 
            xlab("Sampling Date") +
            ylab("Sodium (Na) PPM") +
            ggtitle("Sodium (Na) PPM over time")
```


```{r Sodium  PPM over time w/ irr facet}
## lets facet_wrap() by irrigation season
ggplot(sd, aes(x=sd$Year, y=sd$ExchNa_ppm, col=as.factor(sd$Depth_1))) + 
            geom_point() + theme_bw() + theme(legend.position="top") + 
            geom_smooth(se=FALSE, method="lm") + 
            geom_smooth(aes(x=sd$Year, y=sd$ExchNa_ppm), col="blue", se=FALSE, method='lm') + 
            facet_wrap(sd$Irr_season) +
            xlab("Sampling Date") +
            ylab("Sodium (Na) PPM") +
            ggtitle("Sodium (Na) PPM over time by irrigation season")

```

```{r Sodium  PPM over time w/ irr facet}
## lets facet_wrap() by irrigation season
ggplot(sd, aes(x=sd$Year, y=sd$ExchMg_ppm, col=as.factor(sd$Depth_1))) + 
            geom_point() + theme_bw() + theme(legend.position="top") + 
            geom_smooth(se=FALSE, method="lm") + 
            geom_smooth(aes(x=sd$Year, y=sd$ExchMg_ppm), col="blue", se=FALSE, method='lm') + 
            facet_wrap(sd$Irr_season) +
            xlab("Sampling Date") +
            ylab("Sodium (Na) PPM") +
            ggtitle("Sodium (Na) PPM over time by irrigation season")

```


## Exchangable Potassium (K) Parts Per Million
```{r Potassium PPM over }

ggplot(sd, aes(x=sd$Year, y=sd$ExchK_ppm, col=as.factor(sd$Depth_1))) + 
            geom_point() + theme_bw() + theme(legend.position="top") + 
            geom_smooth(se=FALSE, method="lm") + 
            geom_smooth(aes(x=sd$Year, y=sd$ExchK_ppm), col="blue", se=FALSE, method='lm') + 
            xlab("Sampling Date") +
            ylab("Potassium (K) PPM") +
            ggtitle("Potassium (K) PPM over time")
```


```{r Potassium  PPM over time w/ irr facet}
## lets facet_wrap() by irrigation season
ggplot(sd, aes(x=sd$Year, y=sd$ExchK_ppm, col=as.factor(sd$Depth_1))) + 
            geom_point() + theme_bw() + theme(legend.position="top") + 
            geom_smooth(se=FALSE, method="lm") + 
            geom_smooth(aes(x=sd$Year, y=sd$ExchK_ppm), col="blue", se=FALSE, method='lm') + 
            facet_wrap(sd$Irr_season) +
            xlab("Sampling Date") +
            ylab("Potassium (K) PPM") +
            ggtitle("Potassium (K) PPM over time by irrigation season")

```


## Using Date_Sampled as the X axis

```{r}

```

